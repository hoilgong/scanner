<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Kurly Scanner</title>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">

<style>
  :root {
    --kurly-purple: #5f0080; /* ì»¬ë¦¬ ì‹œê·¸ë‹ˆì²˜ ë³´ë¼ìƒ‰ */
    --kurly-bg: #f7f7f7;      /* ë°°ê²½ íšŒìƒ‰ */
    --text-dark: #333333;
    --text-gray: #999999;
  }

  * { box-sizing: border-box; }
  html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
  
  body { 
    font-family: 'Noto Sans KR', sans-serif; 
    background-color: var(--kurly-bg);
    display: flex; flex-direction: column; align-items: center;
    padding: 15px; color: var(--text-dark);
  }

  /* ìƒë‹¨ í—¤ë” */
  #header {
    width: 100%; max-width: 420px;
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 15px; padding: 0 5px;
  }
  #logo {
    color: var(--kurly-purple); font-weight: 700; font-size: 20px; letter-spacing: -0.5px;
  }
  #status-badge {
    background: white; color: var(--text-dark);
    padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  /* ìŠ¤ìºë„ˆ ì˜ì—­ */
  #scanner-frame {
    width: 100%; max-width: 420px; height: 220px;
    border-radius: 8px; overflow: hidden; position: relative;
    background: #000; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    flex-shrink: 0; /* í™”ë©´ ì‘ì•„ì ¸ë„ ì°Œê·¸ëŸ¬ì§ ë°©ì§€ */
  }
  video { width: 100%; height: 100%; object-fit: cover; }
  .scan-line {
    position: absolute; top: 50%; left: 10%; width: 80%; height: 2px;
    background: var(--kurly-purple); 
    box-shadow: 0 0 4px rgba(95, 0, 128, 0.8);
    transform: translateY(-50%); opacity: 0.8;
  }

  /* ê²°ê³¼ ì¹´ë“œ (í•µì‹¬ UI) */
  #result-card {
    flex-grow: 1; width: 100%; max-width: 420px;
    background: white; border-radius: 12px; margin-top: 15px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    padding: 25px 20px;
    display: flex; flex-direction: column; 
    text-align: left;
    transition: all 0.2s;
  }

  /* ì •ë³´ ë¼ë²¨ ìŠ¤íƒ€ì¼ */
  .label { font-size: 12px; color: var(--text-gray); margin-bottom: 4px; }
  
  /* ìƒí’ˆëª… */
  #product-name { 
    font-size: 20px; font-weight: 700; line-height: 1.4; color: var(--text-dark);
    margin-bottom: 8px; min-height: 56px; /* ë‘ ì¤„ í™•ë³´ */
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
  }
  
  /* ìƒí’ˆì½”ë“œ */
  #product-code { 
    font-size: 14px; color: #666; font-family: 'Courier New', monospace; 
    background: #f0f0f0; display: inline-block; padding: 2px 6px; border-radius: 4px;
    margin-bottom: 20px;
  }

  /* í•˜ë‹¨ ê·¸ë¦¬ë“œ (ì§€ë²ˆ, ì¡´) */
  .info-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
    margin-top: auto; /* ì¹´ë“œë¥¼ ê½‰ ì±„ìš°ë„ë¡ ì•„ë˜ë¡œ ë°€ê¸° */
    border-top: 1px solid #eee; padding-top: 20px;
  }
  .info-item { display: flex; flex-direction: column; }
  .info-value { 
    font-size: 32px; font-weight: 700; color: var(--kurly-purple); 
    letter-spacing: -1px;
  }

  /* ë²„íŠ¼ */
  #action-btn {
    width: 100%; max-width: 420px; margin-top: 15px;
    padding: 16px; font-size: 16px; font-weight: 700;
    background: var(--kurly-purple); color: white;
    border: none; border-radius: 6px; cursor: pointer;
    box-shadow: 0 4px 10px rgba(95, 0, 128, 0.2);
    display: none; /* ì´ˆê¸°ì—” ìˆ¨ê¹€ */
  }
  #action-btn:active { background: #4a0063; transform: scale(0.98); }

  /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
  #loading {
    position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 999;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
  }
  .spinner {
    width: 30px; height: 30px; border: 3px solid #eee; border-top-color: var(--kurly-purple);
    border-radius: 50%; animation: spin 0.8s infinite linear;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  
  /* ìƒíƒœ ë©”ì‹œì§€ (ë¯¸ë“±ë¡ ë“±) */
  .not-found { color: #e02020 !important; }

</style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <p style="margin-top:15px; font-size:14px; color:#5f0080; font-weight:500;">ìƒí’ˆì •ë³´ ë™ê¸°í™” ì¤‘...</p>
</div>

<div id="header">
  <div id="logo">Kurly Work</div>
  <div id="status-badge" onclick="manualRefresh()">ì—…ë°ì´íŠ¸: ëŒ€ê¸°ì¤‘</div>
</div>

<div id="scanner-frame">
  <div class="scan-line"></div>
  <video id="video" muted playsinline></video>
</div>

<div id="result-card">
  <div class="label">ìƒí’ˆëª…</div>
  <div id="product-name">ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•´ì£¼ì„¸ìš”</div>

  <div class="label">ìƒí’ˆì½”ë“œ</div>
  <div id="product-code">-</div>

  <div class="info-grid">
    <div class="info-item">
      <div class="label">ì§€ë²ˆ</div>
      <div id="jibun-val" class="info-value">-</div>
    </div>
    <div class="info-item">
      <div class="label">ì¡´(Zone)</div>
      <div id="zone-val" class="info-value">-</div>
    </div>
  </div>
</div>

<button id="action-btn">ë‹¤ìŒ ìŠ¤ìº”</button>

<script>
// ============================================================
// ğŸ‘‡ ë°°í¬ëœ ìƒˆ GAS URLì„ ì—¬ê¸°ì— ë„£ìœ¼ì„¸ìš”
const GAS_URL = "https://script.google.com/macros/s/AKfycbxZ8_Sg90rJC8IczpXmK0NTRDuI1QV6B5_h1AYN_gpnV750ZuDBZHker78bBZJoe1mj/exec";
// ============================================================

let skuMap = {};
let scanning = false;
let codeReader = new ZXing.BrowserMultiFormatReader();

const els = {
  loading: document.getElementById("loading"),
  status: document.getElementById("status-badge"),
  name: document.getElementById("product-name"),
  code: document.getElementById("product-code"),
  jibun: document.getElementById("jibun-val"),
  zone: document.getElementById("zone-val"),
  btn: document.getElementById("action-btn")
};

// 1. ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
async function fetchData(isBackground = false) {
  if (!isBackground) els.loading.style.display = "flex";

  try {
    const res = await fetch(GAS_URL + "?t=" + Date.now());
    const data = await res.json();

    if (data.ERROR) throw new Error(data.ERROR);

    skuMap = data;
    
    // ì‹œê°„ í‘œì‹œ
    const now = new Date();
    const time = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
    els.status.innerText = `ì—…ë°ì´íŠ¸: ${time} (${Object.keys(data).length})`;
    els.status.style.color = "#5f0080"; // ë³´ë¼ìƒ‰

    if (!isBackground) {
      els.loading.style.display = "none";
      startScanner();
    }
  } catch (err) {
    console.error(err);
    if (!isBackground) {
        alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + err.message);
        els.loading.style.display = "none";
    }
  }
}

// 2. ìŠ¤ìºë„ˆ ê°€ë™
async function startScanner() {
  scanning = true;
  els.btn.style.display = "none";
  resetUI("ìŠ¤ìº” ì¤‘...", "waiting");
  
  try {
    await codeReader.decodeFromConstraints(
      { audio: false, video: { facingMode: "environment" } },
      "video",
      (result) => { if (result && scanning) handleScan(result.text); }
    );
  } catch (e) { console.error(e); }
}

// 3. ìŠ¤ìº” ê²°ê³¼ ì²˜ë¦¬
function handleScan(code) {
  scanning = false;
  codeReader.reset();
  
  const cleanCode = String(code).trim();
  const item = skuMap[cleanCode]; // [ì´ë¦„, ì§€ë²ˆ, ì¡´] ë°°ì—´ í˜•íƒœ

  if (item) {
    // ë“±ë¡ëœ ìƒí’ˆ
    updateUI(item[0], cleanCode, item[1], item[2], true);
    if(navigator.vibrate) navigator.vibrate(100);
  } else {
    // ë¯¸ë“±ë¡
    updateUI("ë“±ë¡ë˜ì§€ ì•Šì€ ìƒí’ˆì…ë‹ˆë‹¤", cleanCode, "-", "-", false);
    if(navigator.vibrate) navigator.vibrate([100,50,100]);
  }
  
  els.btn.style.display = "block";
}

// UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateUI(name, code, jibun, zone, isFound) {
  els.name.innerText = name;
  els.code.innerText = code;
  els.jibun.innerText = jibun;
  els.zone.innerText = zone;

  if (isFound) {
    els.name.style.color = "#333";
    els.jibun.classList.remove("not-found");
    els.zone.classList.remove("not-found");
  } else {
    els.name.style.color = "#e02020";
    els.jibun.classList.add("not-found");
    els.zone.classList.add("not-found");
  }
}

function resetUI(msg, state) {
  els.name.innerText = msg;
  if(state === "waiting") {
      els.name.style.color = "#ccc";
      els.code.innerText = "-";
      els.jibun.innerText = "-";
      els.zone.innerText = "-";
  }
}

els.btn.addEventListener("click", startScanner);

function manualRefresh() {
    if(confirm("ë°ì´í„°ë¥¼ ê°±ì‹ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) fetchData(false);
}

// ì´ˆê¸° ì‹¤í–‰ ë° 5ë¶„ ì£¼ê¸° ê°±ì‹ 
fetchData(false);
setInterval(() => fetchData(true), 300000);

</script>
</body>
</html>