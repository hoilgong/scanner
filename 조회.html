<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Kurly ë¶„ë¥˜ PDA</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">

<style>
  :root { --kurly-purple: #5f0080; --kurly-orange: #ff6b00; --bg-gray: #f4f4f4; --text-black: #333; }
  * { box-sizing: border-box; }
   
  body { 
    height: 100vh; margin: 0; padding: 0; 
    overflow: hidden; /* ì „ì²´ í˜ì´ì§€ ìŠ¤í¬ë¡¤ ë°©ì§€ */
    font-family: 'Noto Sans KR', sans-serif; 
    background-color: var(--bg-gray); 
    display: flex; flex-direction: column; 
  }
   
  /* ======================================================== */
  /* [ìˆ˜ì •] í—¤ë” ìŠ¤íƒ€ì¼ - ìƒë‹¨ ê³ ì • ë° ì˜ë¦¼ ë°©ì§€ */
  /* ======================================================== */
  .header { 
    width: 100%; 
    height: 55px; /* ë†’ì´ ì•½ê°„ ì¦ê°€ */
    background: white; 
    border-bottom: 1px solid #ddd; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    padding: 0 15px; 
    flex-shrink: 0; /* ì ˆëŒ€ ì¤„ì–´ë“¤ì§€ ì•ŠìŒ */
    z-index: 1000;
    position: relative;
  }
  .logo { color: var(--kurly-purple); font-weight: 800; font-size: 18px; }
  .home-icon { font-size: 26px; cursor: pointer; padding: 10px; } /* í„°ì¹˜ ì˜ì—­ í™•ëŒ€ */
  .worker-badge { font-size: 13px; font-weight: bold; background: #eee; padding: 6px 12px; border-radius: 15px; color: #555; }

  /* í™”ë©´ ë¶„ë¦¬ ìŠ¤íƒ€ì¼ */
  .screen { 
    display: none !important; 
    width: 100%; 
    height: 100%; 
    flex-direction: column; 
    background-color: var(--bg-gray);
    position: absolute; 
    inset: 0;
    z-index: 10;
  }
   
  .screen.active { 
    display: flex !important; 
    z-index: 20; 
  }

  /* ë¡œê·¸ì¸ ëª¨ë‹¬ */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 5000; display: flex; justify-content: center; align-items: center; }
  .modal-box { background: white; width: 85%; max-width: 320px; padding: 30px 20px; border-radius: 15px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
  .modal-input { width: 100%; padding: 15px; font-size: 20px; text-align: center; border: 2px solid var(--kurly-purple); border-radius: 8px; margin: 20px 0; font-weight: bold; outline: none; }
  .modal-btn { width: 100%; padding: 15px; font-size: 18px; font-weight: bold; background: var(--kurly-purple); color: white; border: none; border-radius: 8px; cursor: pointer; }

  /* 1. í™ˆ í™”ë©´ (ì†¡ì¥ ì„ íƒ) */
  #home-screen { justify-content: center; align-items: center; padding: 20px; gap: 20px; }
  
  .mode-btn { 
    width: 100%; max-width: 320px; height: 140px; 
    border: none; border-radius: 15px; 
    font-size: 28px; font-weight: 900; color: white; 
    cursor: pointer; 
    display: flex; flex-direction: column; justify-content: center; align-items: center; 
    box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
    transition: transform 0.1s; 
    position: relative; overflow: hidden;
  }
  .mode-btn:active { transform: scale(0.98); }
  
  /* ì†¡ì¥ ìˆìŒ (ì£¼í™©ìƒ‰) */
  .btn-invoice { background: linear-gradient(135deg, #ff6b00, #ff8e3c); }
  /* ì†¡ì¥ ì—†ìŒ (ë³´ë¼ìƒ‰) */
  .btn-scan { background: linear-gradient(135deg, #5f0080, #7e00ac); }
  
  .btn-sub { font-size: 16px; font-weight: 500; margin-top: 8px; opacity: 0.9; }
  .btn-icon { font-size: 40px; margin-bottom: 5px; }

  /* 2. ì‘ì—… í™”ë©´ */
  #work-screen { 
    /* ì¤‘ìš”: ì „ì²´ íŒ¨ë”© ì œê±° (í—¤ë” ê½‰ ì°¨ê²Œ í•˜ê¸° ìœ„í•¨) */
    padding: 0; 
  }
  
  /* [ìˆ˜ì •] ì‘ì—… í™”ë©´ ë‚´ë¶€ ì»¨í…ì¸  ë˜í¼ (í—¤ë” ì•„ë˜ ë‚´ìš©ë§Œ íŒ¨ë”© ì ìš©) */
  .work-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 10px;
    overflow: hidden; /* ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì œì–´ */
  }
   
  #mode-indicator { text-align: center; padding: 10px; font-weight: bold; color: white; border-radius: 8px; margin-bottom: 10px; font-size: 16px; flex-shrink: 0; }
  .bg-Y { background: var(--kurly-orange); } 
  .bg-N { background: var(--kurly-purple); } 

  #big-zone-display { 
    background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; 
    text-align: center; border: 3px solid var(--kurly-purple); flex-shrink: 0;
    min-height: 120px; display: flex; flex-direction: column; justify-content: center;
  }
  .zone-label { font-size: 14px; color: #888; margin-bottom: 5px; }
  .zone-val { font-size: 65px; font-weight: 900; color: var(--kurly-purple); line-height: 1; margin: 5px 0; }
  .p-name-val { font-size: 18px; color: #333; font-weight: bold; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* ì…ë ¥ì°½ */
  #input-box { display: flex; gap: 5px; margin-bottom: 10px; flex-shrink: 0; }
  #scan-input { 
    flex: 1; padding: 15px; border: 3px solid #ddd; border-radius: 8px; 
    font-size: 18px; outline: none; text-align: center; font-weight: bold; 
    ime-mode: disabled; 
  }
  #scan-input:focus { border-color: var(--kurly-purple); }
   
  /* ë¦¬ìŠ¤íŠ¸ ì˜ì—­ */
  #list-area { 
    flex-grow: 1; 
    background: white; 
    border-radius: 8px; 
    overflow-y: auto; 
    border: 1px solid #ddd; 
    display: flex; 
    flex-direction: column; 
    -webkit-overflow-scrolling: touch; /* ëª¨ë°”ì¼ ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
  }
   
  .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 10px; border-bottom: 1px solid #eee; }
  .list-item.latest { background-color: #fff0f5; }
   
  .item-info { flex: 1; overflow: hidden; }
  .item-row1 { font-size: 15px; font-weight: bold; color: #333; margin-bottom: 2px; }
  .item-row2 { font-size: 13px; color: #888; display: flex; gap: 10px; }
   
  .btn-del { width: 40px; height: 40px; background: #eee; color: #888; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 18px; margin-left: 10px; cursor: pointer; flex-shrink: 0; }
  .btn-del:active { background: #ff4444; color: white; }

  #bottom-bar { margin-top: 10px; flex-shrink: 0; }
  .action-btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 20px; font-weight: 900; color: white; cursor: pointer; background: #333; }
  .action-btn:active { opacity: 0.9; }

  /* ë¡œë”© */
  #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 6000; display: none; justify-content: center; align-items: center; flex-direction: column; }
  .spinner { width: 40px; height: 40px; border: 5px solid #ddd; border-top-color: var(--kurly-purple); border-radius: 50%; animation: spin 1s infinite linear; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <p id="loading-txt" style="margin-top:20px; color:#5f0080; font-weight:bold;">ë°ì´í„° ë™ê¸°í™” ì¤‘...</p>
</div>

<div id="login-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="logo" style="font-size:22px; margin-bottom:10px;">Kurly ë¶„ë¥˜ ì‘ì—…</div>
    <div style="font-size:14px; color:#888;">ì‘ì—…ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</div>
    <input type="text" id="worker-input" class="modal-input" placeholder="ì´ë¦„ ì…ë ¥" autocomplete="off">
    <button class="modal-btn" onclick="confirmWorker()">ì‘ì—… ì‹œì‘</button>
  </div>
</div>

<div id="home-screen" class="screen">
  <div class="logo" style="margin-bottom: 10px; font-size:24px;">ì‘ì—… ëª¨ë“œ ì„ íƒ</div>
  <div id="worker-display" class="worker-badge" style="margin-bottom:20px;">ì‘ì—…ì: -</div>
  
  <button class="mode-btn btn-invoice" onclick="startMode('Y')">
    <span class="btn-icon">ğŸ“œ</span>
    <span>ì†¡ì¥ O (ìˆìŒ)</span>
    <span class="btn-sub">ëª©ë¡ ìŠ¤ìº” í›„ ì „ì†¡</span>
  </button>
  
  <button class="mode-btn btn-scan" onclick="startMode('N')">
    <span class="btn-icon">ğŸ“¦</span>
    <span>ì†¡ì¥ X (ì—†ìŒ)</span>
    <span class="btn-sub">ëª©ë¡ ìŠ¤ìº” í›„ ì „ì†¡</span>
  </button>
  
  <div style="margin-top:20px; color:#999; font-size:13px;">DB ë°ì´í„°: <span id="db-count">0</span>ê°œ</div>
</div>

<div id="work-screen" class="screen">
  <div class="header">
    <div class="home-icon" onclick="goHome()">ğŸ </div>
    <div class="logo">Scanner</div>
    <div class="worker-badge" id="header-worker">-</div>
  </div>
  
  <div class="work-body">
    <div id="mode-indicator"></div>
    
    <div id="big-zone-display">
      <div class="zone-label">ì ì¹˜ì¡´ (ZONE)</div>
      <div class="zone-val" id="disp-zone">-</div>
      <div class="p-name-val" id="disp-name">ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”</div>
    </div>
    
    <div id="input-box">
      <input type="text" id="scan-input" placeholder="ë°”ì½”ë“œ ìŠ¤ìº”" autocomplete="off" inputmode="url">
    </div>
    
    <div id="list-area"></div>
    
    <div id="bottom-bar">
      <button class="action-btn" onclick="finishWork()">âœ… ì‘ì—… ì™„ë£Œ (ì „ì†¡)</button>
    </div>
  </div>
</div>

<script>
// â–¼â–¼â–¼ ìŠ¤í¬ë¦½íŠ¸ ì£¼ì†Œ (ìœ ì§€) â–¼â–¼â–¼
const GAS_URL = "https://script.google.com/macros/s/AKfycbxo79JNCPZa7YMWYKTZGWkI5FZrOcXunyz7oh03PAuv2zC-sCwN5DfafceMubARI9iz/exec";

let skuMap = {};
let currentMode = null; 
let scanList = []; 
let currentWorker = ""; 

const els = {
  loginModal: document.getElementById("login-modal"),
  workerInput: document.getElementById("worker-input"),
  homeScreen: document.getElementById("home-screen"),
  workScreen: document.getElementById("work-screen"),
  workerDisplay: document.getElementById("worker-display"),
  headerWorker: document.getElementById("header-worker"),
  
  modeIndicator: document.getElementById("mode-indicator"),
  scanInput: document.getElementById("scan-input"),
  listArea: document.getElementById("list-area"),
  loading: document.getElementById("loading"),
  loadingTxt: document.getElementById("loading-txt"),
  dbCount: document.getElementById("db-count"),
  dispZone: document.getElementById("disp-zone"),
  dispName: document.getElementById("disp-name"),
  bigDisplay: document.getElementById("big-zone-display")
};

window.onload = async () => {
  els.workerInput.focus(); 
  els.loadingTxt.innerText = "DB ë¡œë“œ ì¤‘...";
  try {
    const res = await fetch(GAS_URL + "?t=" + Date.now());
    const data = await res.json();
    skuMap = data;
    els.dbCount.innerText = Object.keys(data).length;
  } catch(e) {
    alert("DB ë¡œë“œ ì‹¤íŒ¨");
  }
};

function confirmWorker() {
  const name = els.workerInput.value.trim();
  if(!name) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }
  currentWorker = name;
  els.workerDisplay.innerText = "ì‘ì—…ì: " + name;
  els.headerWorker.innerText = name;
  
  els.loginModal.style.display = "none";
  // í™ˆ í™”ë©´ ë³´ì´ê¸°
  els.homeScreen.classList.add("active");
  els.workScreen.classList.remove("active");
}

function startMode(mode) {
  currentMode = mode;
  scanList = []; 
  els.dispZone.innerText = "-";
  els.dispName.innerText = "ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”";
  els.listArea.innerHTML = '<div style="text-align:center; color:#999; padding:30px;">ëª©ë¡ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤.</div>';
  
  // í™”ë©´ êµì²´
  els.homeScreen.classList.remove("active");
  els.workScreen.classList.add("active");
  
  if (mode === 'Y') {
    els.modeIndicator.innerText = "ğŸ“œ ì†¡ì¥ O (ìˆìŒ) ëª¨ë“œ";
    els.modeIndicator.className = "bg-Y";
    els.bigDisplay.style.borderColor = "#ff6b00";
    els.dispZone.style.color = "#ff6b00";
  } else {
    els.modeIndicator.innerText = "ğŸ“¦ ì†¡ì¥ X (ì—†ìŒ) ëª¨ë“œ";
    els.modeIndicator.className = "bg-N";
    els.bigDisplay.style.borderColor = "#5f0080";
    els.dispZone.style.color = "#5f0080";
  }
  forceFocus();
}

function goHome() {
  if (scanList.length > 0) {
    if (!confirm("ì‘ì—… ì¤‘ì¸ ëª©ë¡ì´ ìˆìŠµë‹ˆë‹¤.\nì €ì¥í•˜ì§€ ì•Šê³  ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  }
  // í™”ë©´ êµì²´ (ì‘ì—… ìˆ¨ê¹€, í™ˆ ë³´ì„)
  els.workScreen.classList.remove("active");
  els.homeScreen.classList.add("active");
}

function handleScan(code) {
  code = code.trim();
  if (!code) return;

  const item = skuMap[code] || ["ë¯¸ë“±ë¡ ìƒí’ˆ", code, "-", "?"];
  
  const scanData = {
    code: item[1], 
    name: item[0],
    jibun: item[2], 
    zone: item[3]   
  };

  scanList.push(scanData);

  els.dispZone.innerText = scanData.zone || "?";
  els.dispName.innerText = scanData.name;
  
  renderList();
  els.scanInput.value = "";
  forceFocus();
}

function renderList() {
  if (scanList.length === 0) {
    els.listArea.innerHTML = '<div style="text-align:center; color:#999; padding:30px;">ëª©ë¡ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤.</div>';
    return;
  }
  let html = `<div style="padding:10px; text-align:right; font-weight:bold; border-bottom:1px solid #ddd; background:#fff;">ëŒ€ê¸° ì¤‘: ${scanList.length}ê±´</div>`;
  for (let i = scanList.length - 1; i >= 0; i--) {
    const item = scanList[i];
    const isLatest = (i === scanList.length - 1) ? "latest" : "";
    html += `
      <div class="list-item ${isLatest}">
        <div class="item-info">
          <div class="item-row1">${item.name}</div>
          <div class="item-row2">
            <span>ì½”ë“œ: ${item.code}</span>
            <span>ì§€ë²ˆ: ${item.jibun}</span>
          </div>
        </div>
        <div class="btn-del" onclick="deleteItem(${i})">X</div>
      </div>
    `;
  }
  els.listArea.innerHTML = html;
}

window.deleteItem = function(index) {
  if(confirm("ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    scanList.splice(index, 1); 
    renderList();
    if(scanList.length > 0) {
      const last = scanList[scanList.length - 1];
      els.dispZone.innerText = last.zone;
      els.dispName.innerText = last.name;
    } else {
      els.dispZone.innerText = "-";
      els.dispName.innerText = "ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”";
    }
  }
  forceFocus();
}

async function finishWork() {
  if (scanList.length === 0) {
    alert("ì „ì†¡í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  if(!confirm(`ì´ ${scanList.length}ê±´ì„ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

  els.loadingTxt.innerText = "ì„œë²„ë¡œ ì €ì¥ ì¤‘...";
  els.loading.style.display = 'flex';

  try {
    const payload = {
      type: currentMode,
      workerName: currentWorker,
      data: scanList
    };
    await fetch(GAS_URL, {
      method: "POST",
      mode: "no-cors",
      body: JSON.stringify(payload)
    });
    alert("âœ… ì €ì¥ ì™„ë£Œ!");
    scanList = [];
    els.workScreen.classList.remove("active");
    els.homeScreen.classList.add("active");
  } catch(e) {
    alert("ì „ì†¡ ì˜¤ë¥˜");
  } finally {
    els.loading.style.display = 'none';
  }
}

function forceFocus() {
  // í™ˆ í™”ë©´ì¼ ë•ŒëŠ” í¬ì»¤ìŠ¤ ê¸ˆì§€
  if (!els.workScreen.classList.contains("active")) return;
  els.scanInput.type = "password";
  els.scanInput.focus();
  setTimeout(() => els.scanInput.type = "text", 50);
}

els.scanInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") handleScan(els.scanInput.value);
});
els.workerInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") confirmWorker();
});

document.addEventListener("click", (e) => {
  // ì‘ì—… í™”ë©´ì´ê³ , ë²„íŠ¼/ì¸í’‹ì´ ì•„ë‹ ë•Œë§Œ í¬ì»¤ìŠ¤ ê°•ì œ
  if (els.workScreen.classList.contains("active") && 
      !e.target.closest("button") && 
      !e.target.closest("input") && 
      !e.target.closest(".btn-del")) {
    forceFocus();
  }
});
</script>
</body>
</html>