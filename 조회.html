<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>상품 존 조회 (ZXing)</title>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
  html, body{
    height:100%;
    margin:0;
    padding:0;
    overflow:hidden;
  }
  body{
    font-family:Arial;
    padding:20px;
    touch-action:none;
  }

  #scanner{
    width:100%;
    max-width:380px;
    height:240px;
    margin:auto;
    border:2px solid #888;
    border-radius:8px;
    overflow:hidden;
    position:relative;
  }
  video{
    width:100%;
    height:100%;
    object-fit:cover;
  }

  .scan-line{
    position:absolute;
    top:50%;
    left:0;
    width:100%;
    height:2px;
    background:red;
    opacity:0.85;
    transform:translateY(-50%);
  }

  #zone{
    margin-top:20px;
    font-size:22px;
    font-weight:bold;
  }

  #restartBtn{
    margin-top:20px;
    padding:10px 15px;
    font-size:18px;
  }

  @media(max-width:600px){
    #scanner{
      height:200px;
      max-width:330px;
    }
  }
</style>
</head>
<body>

<h2>상품 존 조회 (ZXing)</h2>

<div id="scanner">
  <div class="scan-line"></div>
  <video id="video" muted playsinline></video>
</div>

<div id="zone">스캔 후 존이 표시됩니다</div>

<button id="restartBtn">다음 스캔</button>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbxZ8_Sg90rJC8IczpXmK0NTRDuI1QV6B5_h1AYN_gpnV750ZuDBZHker78bBZJoe1mj/exec";

const codeReader = new ZXing.BrowserMultiFormatReader();
let scanning = false;

// ===== 스캔 시작 =====
async function startScanner(){
  scanning = true;
  const video = document.getElementById("video");

  await codeReader.decodeFromConstraints(
    {
      audio: false,
      video:{ facingMode:"environment" }
    },
    video,
    (result,err)=>{
      if(result && scanning){
        scanning = false;
        codeReader.reset();

        const code = String(result.text).trim();

        // === 여기서 GAS 호출 (단일 조회)
        fetch(GAS_URL + "?code=" + encodeURIComponent(code))
          .then(r=>r.text())
          .then(zone=>{
            document.getElementById("zone").innerText =
              `바코드: ${code} / 존: ${zone}`;

            if(navigator.vibrate){
              navigator.vibrate(200);
            }
          });
      }
    },
    { tryHarder:true }
  );
}

startScanner();

// ===== 다음 스캔 =====
document.getElementById("restartBtn").addEventListener("click", ()=>{
  document.getElementById("zone").innerText = "스캔 후 존이 표시됩니다";
  startScanner();
});
</script>

</body>
</html>
