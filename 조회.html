<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ìŠ¤ë§ˆíŠ¸ ì¡´ ì¡°íšŒê¸°</title>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<style>
  * { box-sizing: border-box; }
  html, body{ height:100%; margin:0; padding:0; overflow:hidden; }
  body{ 
    font-family: 'Apple SD Gothic Neo', sans-serif; 
    background-color: #f0f2f5;
    display:flex; flex-direction:column; align-items:center; 
    padding: 10px;
  }

  /* ìƒë‹¨ ìƒíƒœë°” */
  #header {
    width: 100%; max-width: 420px;
    display: flex; justify-content: space-between; align-items: center;
    background: white; padding: 12px 15px;
    border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    margin-bottom: 15px; font-size: 13px;
  }
  #status-text { font-weight: bold; color: #555; }
  #refresh-btn { 
    background: #e7f1ff; color: #007bff; border: none;
    padding: 6px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;
  }

  /* ìŠ¤ìºë„ˆ ì˜ì—­ */
  #scanner-container {
    width: 100%; max-width: 420px; 
    height: 250px; flex-shrink: 0;
    position: relative; overflow: hidden;
    border-radius: 12px; border: 2px solid #333; background: #000;
  }
  video { width: 100%; height: 100%; object-fit: cover; }
  .scan-line {
    position: absolute; top: 50%; left: 0; width: 100%; height: 2px;
    background: #00ff00; box-shadow: 0 0 4px #00ff00;
    transform: translateY(-50%); opacity: 0.7;
  }

  /* ê²°ê³¼ í‘œì‹œ ì˜ì—­ */
  #result-area {
    flex-grow: 1; width: 100%; max-width: 420px;
    background: white; margin-top: 15px; border-radius: 12px;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.05); padding: 20px; text-align: center;
  }
  #code-label { font-size: 14px; color: #888; margin-bottom: 5px; }
  #zone-result { font-size: 42px; font-weight: 900; color: #333; margin-bottom: 15px; line-height: 1.1; }
  
  /* ë²„íŠ¼ */
  #next-btn {
    width: 80%; padding: 15px; font-size: 18px; font-weight: bold;
    background: #28a745; color: white; border: none; border-radius: 50px;
    box-shadow: 0 4px 6px rgba(40,167,69,0.3); cursor: pointer;
    display: none; /* ì´ˆê¸°ì—” ìˆ¨ê¹€ */
  }

  /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
  #loading {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255,255,255,0.95); z-index: 9999;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
  }
  .spinner {
    width: 40px; height: 40px; border: 4px solid #ddd; 
    border-top-color: #007bff; border-radius: 50%; animation: spin 1s infinite linear;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #error-msg { color: red; margin-top: 15px; text-align: center; padding: 0 20px; font-weight: bold;}
</style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <p style="margin-top:15px; color:#555;">ìµœì‹  ë°ì´í„° ë™ê¸°í™” ì¤‘...</p>
  <div id="error-msg"></div>
</div>

<div id="header">
  <div id="status-text">ì—°ê²° ëŒ€ê¸° ì¤‘...</div>
  <button id="refresh-btn" onclick="manualRefresh()">ğŸ”„ ê°±ì‹ </button>
</div>

<div id="scanner-container">
  <div class="scan-line"></div>
  <video id="video" muted playsinline></video>
</div>

<div id="result-area">
  <div id="code-label">ë°”ì½”ë“œë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”</div>
  <div id="zone-result">-</div>
  <button id="next-btn">ë‹¤ìŒ ìŠ¤ìº”</button>
</div>

<script>
// ============================================================
// ğŸ‘‡ ì—¬ê¸°ì— ë°°í¬ëœ ìƒˆ ì›¹ ì•± URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”
const GAS_URL = "https://script.google.com/macros/s/AKfycbxh3HoolEcw4a2xb2VsS7X0OyiCZcjqaSzU1Q9EhlpBk7J1vfKI5VnAIMbAJ2Ih7ZFe/exec";
// ============================================================

let skuMap = {};
let scanning = false;
let codeReader = new ZXing.BrowserMultiFormatReader();
const loadingEl = document.getElementById("loading");
const errorEl = document.getElementById("error-msg");
const statusEl = document.getElementById("status-text");
const zoneEl = document.getElementById("zone-result");
const codeEl = document.getElementById("code-label");
const nextBtn = document.getElementById("next-btn");

// 1. ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í•µì‹¬ ë¡œì§)
async function fetchData(isBackground = false) {
  if (!isBackground) {
    loadingEl.style.display = "flex";
    errorEl.innerText = "";
  }

  try {
    // ìºì‹œ ë°©ì§€ìš© íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
    const response = await fetch(GAS_URL + "?t=" + new Date().getTime());
    
    // ì‘ë‹µ í…ìŠ¤íŠ¸ ë¨¼ì € í™•ì¸ (ë””ë²„ê¹…ìš©)
    const textData = await response.text();
    let data;

    try {
      data = JSON.parse(textData);
    } catch (e) {
      throw new Error("ì„œë²„ ì‘ë‹µì´ JSONì´ ì•„ë‹™ë‹ˆë‹¤. (ê¶Œí•œ ë¬¸ì œì¼ ìˆ˜ ìˆìŒ)");
    }

    // ì„œë²„ê°€ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ ê²½ìš° (ì˜ˆ: ì‹œíŠ¸ ì—†ìŒ)
    if (data.ERROR) {
      throw new Error(data.ERROR);
    }

    // ì„±ê³µ ì‹œ ë°ì´í„° ì €ì¥
    skuMap = data;
    
    // ì‹œê°„ ë° ê°œìˆ˜ í‘œì‹œ
    const now = new Date();
    const timeStr = now.getHours().toString().padStart(2,'0') + ":" + 
                    now.getMinutes().toString().padStart(2,'0');
    statusEl.innerHTML = `ê¸°ì¤€: ${timeStr} <span style='color:#007bff'>(${Object.keys(data).length}ê°œ)</span>`;

    if (!isBackground) {
      loadingEl.style.display = "none";
      startScanner();
    } else {
      console.log("ë°±ê·¸ë¼ìš´ë“œ ê°±ì‹  ì™„ë£Œ: " + timeStr);
    }

  } catch (err) {
    console.error(err);
    if (!isBackground) {
      document.querySelector(".spinner").style.display = "none";
      errorEl.innerText = "âš ï¸ ë¡œë“œ ì‹¤íŒ¨:\n" + err.message;
      alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨!\n\nì›ì¸: " + err.message);
    }
  }
}

// 2. ìŠ¤ìºë„ˆ ì‹œì‘
async function startScanner(){
  scanning = true;
  nextBtn.style.display = "none";
  zoneEl.innerText = "ìŠ¤ìº” ì¤‘...";
  zoneEl.style.color = "#ccc";
  codeEl.innerText = "";

  try {
    await codeReader.decodeFromConstraints(
      { audio: false, video: { facingMode: "environment" } },
      "video",
      (result, err) => {
        if (result && scanning) {
          handleScan(result.text);
        }
      }
    );
  } catch (err) {
    console.error(err);
    zoneEl.innerText = "ì¹´ë©”ë¼ ì˜¤ë¥˜";
  }
}

// 3. ìŠ¤ìº” ì²˜ë¦¬
function handleScan(code) {
  scanning = false;
  codeReader.reset(); // ì¹´ë©”ë¼ ì •ì§€

  const cleanCode = String(code).trim();
  const foundZone = skuMap[cleanCode];

  codeEl.innerText = "CODE: " + cleanCode;

  if (foundZone) {
    zoneEl.innerText = foundZone;
    zoneEl.style.color = "#333";
  } else {
    zoneEl.innerText = "ë¯¸ë“±ë¡";
    zoneEl.style.color = "red";
    if (navigator.vibrate) navigator.vibrate([200]);
  }

  nextBtn.style.display = "block";
}

// 4. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
nextBtn.addEventListener("click", () => {
  startScanner();
});

function manualRefresh() {
  if (confirm("ë°ì´í„°ë¥¼ ìµœì‹ ìœ¼ë¡œ ì—…ë°ì´íŠ¸ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    fetchData(false);
  }
}

// === ì‹¤í–‰ ===
// ì´ˆê¸° ë¡œë”© ì‹¤í–‰
fetchData(false);

// 5ë¶„(300,000ms)ë§ˆë‹¤ ë°±ê·¸ë¼ìš´ë“œ ìë™ ê°±ì‹ 
setInterval(() => {
  fetchData(true);
}, 300000);

</script>
</body>
</html>