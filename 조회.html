<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>상품 존 조회 (ZXing)</title>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
  html, body{margin:0;padding:0;}
  body{padding:20px;font-family:Arial;}
  #scanner{width:100%;max-width:380px;height:240px;margin:auto;border:2px solid #888;position:relative;}
  video{width:100%;height:100%;object-fit:cover;}
  .scan-line{position:absolute;top:50%;left:0;width:100%;height:2px;background:red;}
  #zone{margin-top:20px;font-size:22px;font-weight:bold;}
</style>
</head>
<body>

<h2>상품 존 조회 (ZXing)</h2>

<div id="scanner">
  <div class="scan-line"></div>
  <video id="video" muted playsinline></video>
</div>

<div id="zone">데이터 불러오는 중...</div>

<button id="restartBtn" style="margin-top:20px;">다음 스캔</button>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbxZ8_Sg90rJC8IczpXmK0NTRDuI1QV6B5_h1AYN_gpnV750ZuDBZHker78bBZJoe1mj/exec";

let skuMap = {};        // 전체 데이터 보관
let scanning = false;
const codeReader = new ZXing.BrowserMultiFormatReader();

// ① 페이지 처음 켜질 때 전체 MAP 받아오기
fetch(GAS_URL + "?type=all")
  .then(r=>r.json())
  .then(data=>{
     skuMap = data;
     document.getElementById("zone").innerText="스캔 해주세요";
     startScanner(); // 여기서 스캐너 시작!!
  });

// ② 스캔 시작
async function startScanner(){
  scanning = true;
  const video = document.getElementById("video");

  await codeReader.decodeFromConstraints(
    {video:{facingMode:"environment"}},
    video,
    (result,err)=>{
      if(result && scanning){
        scanning = false;
        codeReader.reset();
        const code = String(result.text).trim();
        const zone = skuMap[code] || "미등록 코드";
        document.getElementById("zone").innerText=`바코드: ${code} / 존: ${zone}`;
        if(navigator.vibrate) navigator.vibrate(200);
      }
    },
    {tryHarder:true}
  );
}

// ③ 다시 스캔 버튼
document.getElementById("restartBtn").addEventListener("click", ()=>{
  document.getElementById("zone").innerText="스캔 해주세요";
  startScanner();
});
</script>

</body>
</html>
