<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Kurly Relocation Fixed</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">

<style>
  :root { --kurly-purple: #5f0080; --kurly-orange: #ff6b00; --bg-gray: #f4f4f4; --text-black: #333; }
  * { box-sizing: border-box; }
  
  body { 
    height: 100vh; margin: 0; padding: 0; overflow: hidden; 
    font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-gray); 
    display: flex; flex-direction: column; 
  }

  /* === 1. ê³ ì • í—¤ë” (í•­ìƒ ë³´ì„) === */
  .header-container {
    flex: 0 0 50px; /* ë†’ì´ ê³ ì • */
    background: white;
    border-bottom: 1px solid #ddd;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 15px;
    z-index: 100;
  }
  .logo { color: var(--kurly-purple); font-weight: 900; font-size: 18px; }
  
  /* ì´ˆê¸°í™” ë²„íŠ¼ (í—¤ë” ìš°ì¸¡) */
  .btn-reset {
    background: #f1f1f1; color: #333; border: 1px solid #ccc;
    padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: bold;
    cursor: pointer; display: flex; align-items: center; gap: 4px;
  }

  /* === 2. ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ === */
  .main-content {
    flex: 1;
    position: relative;
    overflow-y: auto;
    padding: 15px;
    display: flex; flex-direction: column;
  }

  /* ë‹¨ê³„ë³„ í™”ë©´ (ê¸°ë³¸ ìˆ¨ê¹€) */
  .step-screen { display: none; flex-direction: column; height: 100%; }
  .step-screen.active { display: flex; animation: fadeIn 0.3s; }

  /* ê³µí†µ UI */
  .title-label { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #333; }
  .input-box {
    width: 100%; height: 50px; font-size: 20px; text-align: center;
    border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px;
    font-weight: bold; outline: none;
  }
  .input-box:focus { border-color: var(--kurly-purple); }
  
  .btn-action {
    width: 100%; padding: 15px; background: var(--kurly-purple); color: white;
    font-size: 16px; font-weight: bold; border: none; border-radius: 8px;
    margin-top: auto; /* í•˜ë‹¨ ë¶™ì´ê¸° */
  }

  /* [Step 3] ìƒí’ˆ ì •ë³´ ì¹´ë“œ */
  .product-card {
    background: white; padding: 20px; border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; margin-bottom: 20px;
  }
  .p-name { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 5px; word-break: keep-all; }
  .p-code { font-size: 13px; color: #888; margin-bottom: 15px; }

  /* [Step 4] íƒ€ê²Ÿ ì§€ë²ˆ (ê±°ëŒ€ í°íŠ¸) */
  .target-area {
    background: #fff4e6; border: 4px solid var(--kurly-orange);
    border-radius: 12px; text-align: center;
    flex-grow: 1; display: flex; flex-direction: column; justify-content: center;
    margin-bottom: 15px; min-height: 180px;
  }
  .target-label { color: #d9480f; font-size: 14px; font-weight: bold; margin-bottom: 5px; }
  .target-val {
    font-size: 15vw; /* í™”ë©´ ê½‰ ì°¨ê²Œ */
    font-weight: 900; color: var(--kurly-orange);
    line-height: 1; white-space: nowrap;
  }

  /* â˜… ì§€ë²ˆ ì•ˆë‚´ ë¬¸êµ¬ (ìš”ì²­ì‚¬í•­ ë°˜ì˜) */
  .guide-box {
    background-color: #e3f2fd;
    border-left: 5px solid #2196f3;
    padding: 12px; margin-bottom: 15px;
    color: #0d47a1; font-size: 13px; line-height: 1.5;
    border-radius: 4px;
  }

  /* ë¡œë”© ë° ë©”ì‹œì§€ ì˜¤ë²„ë ˆì´ */
  #loading, #msg-overlay {
    position: fixed; inset: 0; z-index: 2000;
    display: none; justify-content: center; align-items: center; flex-direction: column;
  }
  #loading { background: rgba(255,255,255,0.9); }
  #msg-overlay { background: rgba(0,0,0,0.6); color: white; pointer-events: none; }

  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
</head>
<body>

<div class="header-container">
  <div class="logo">Kurly Work</div>
  <button class="btn-reset" onclick="fullReset()">
    <span>â†»</span> ì´ˆê¸°í™”
  </button>
</div>

<div class="main-content">

  <div id="step-1" class="step-screen active">
    <div style="margin-top: 50px; text-align: center;">
      <h2 style="color:var(--kurly-purple);">ì‘ì—…ì ë“±ë¡</h2>
      <p style="color:#666;">ì‘ì—…ì„ ì‹œì‘í•˜ë ¤ë©´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
    </div>
    <input type="text" id="input-name" class="input-box" placeholder="ì´ë¦„ ì…ë ¥" style="margin-top:20px;">
    <button class="btn-action" onclick="goStep2()">ì‘ì—… ì‹œì‘</button>
  </div>

  <div id="step-2" class="step-screen">
    <div class="title-label">ìƒí’ˆ ìŠ¤ìº”</div>
    <div style="background:#ddd; height:200px; border-radius:8px; display:flex; align-items:center; justify-content:center; margin-bottom:20px; color:#666;">
      ğŸ“· ë°”ì½”ë“œ ìŠ¤ìº” ëŒ€ê¸°
    </div>
    <input type="text" id="input-prod" class="input-box" placeholder="ìƒí’ˆë°”ì½”ë“œ ìŠ¤ìº”" autocomplete="off">
    <div style="font-size:12px; color:#888; text-align:center; margin-top:10px;">
      DB ìƒíƒœ: <span id="db-count">0</span>ê°œ ë¡œë“œë¨
    </div>
  </div>

  <div id="step-3" class="step-screen">
    <div class="title-label">ìˆ˜ëŸ‰ ì…ë ¥</div>
    
    <div class="product-card">
      <div class="p-name" id="disp-pname">-</div>
      <div class="p-code" id="disp-pcode">-</div>
      <div style="font-size:14px; color:var(--kurly-purple); font-weight:bold;">ì´ ìƒí’ˆì´ ë§ë‚˜ìš”?</div>
    </div>

    <label style="font-size:13px; color:#666; display:block; margin-bottom:5px;">ì´ë™í•  ìˆ˜ëŸ‰</label>
    <input type="number" id="input-qty" class="input-box" value="1" style="font-size:30px; height:70px;">
    
    <button class="btn-action" onclick="goStep4()">ì§€ë²ˆ í™•ì¸í•˜ëŸ¬ ê°€ê¸°</button>
  </div>

  <div id="step-4" class="step-screen">
    <div class="target-area">
      <div class="target-label">â¬‡ï¸ ì—¬ê¸°ë¡œ ì´ë™í•˜ì„¸ìš”</div>
      <div class="target-val" id="disp-jibun">-</div>
    </div>

    <div class="guide-box">
      [ì•ˆë‚´]<br>
      1. ë¹ˆ ë¡œì¼€ì´ì…˜ì„ ìš°ì„  í™•ì¸í•´ì£¼ì„¸ìš”.<br>
      2. <strong>êµ¬ì—­(A)-ì—´(01)-ë‹¨(02)</strong> í˜•ì‹ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”.<br>
      3. ë™ì¢… ìƒí’ˆì´ ìˆë‹¤ë©´ í•©ì ì¬ í•´ì£¼ì„¸ìš”.
    </div>

    <input type="text" id="input-loc" class="input-box" placeholder="ì§€ë²ˆ ë°”ì½”ë“œ ìŠ¤ìº”" style="border-color:var(--kurly-orange);">
  </div>

</div>

<div id="loading"><p style="color:#5f0080; font-weight:bold;">ë°ì´í„° ë™ê¸°í™” ì¤‘...</p></div>
<div id="msg-overlay">
  <div id="msg-icon" style="font-size:50px;">âœ…</div>
  <div id="msg-text" style="font-size:20px; font-weight:bold;">ì™„ë£Œ</div>
</div>

<script>
// --- ì„¤ì • ë° ë³€ìˆ˜ ---
const GAS_URL = "https://script.google.com/macros/s/AKfycbxlnPMPZAWhPum7f-yl3EVVn_wFqrh_v0GB6Edncx20eglrylv0iDbdET7o_jaPfj3e/exec";
let skuMap = {};
let workerName = "";
let currentItem = null; // { code, name, jibun, qty }

// --- ì´ˆê¸°í™” ë° ë°ì´í„° ë¡œë“œ ---
window.onload = function() {
  document.getElementById('input-name').focus();
  loadData(); // ë°±ê·¸ë¼ìš´ë“œ ë°ì´í„° ë¡œë“œ
};

async function loadData() {
  try {
    const res = await fetch(GAS_URL + "?t=" + Date.now());
    const data = await res.json();
    skuMap = data;
    document.getElementById('db-count').innerText = Object.keys(data).length;
  } catch(e) {
    console.error("DB Load Fail");
  }
}

// --- ë‹¨ê³„ ì´ë™ í•¨ìˆ˜ ---
function showStep(stepNum) {
  // ëª¨ë“  ìŠ¤í… ìˆ¨ê¹€
  document.querySelectorAll('.step-screen').forEach(el => el.classList.remove('active'));
  // í•´ë‹¹ ìŠ¤í… í‘œì‹œ
  document.getElementById('step-' + stepNum).classList.add('active');
  
  // í¬ì»¤ìŠ¤ ìë™ ì´ë™
  if(stepNum === 1) document.getElementById('input-name').focus();
  if(stepNum === 2) {
    document.getElementById('input-prod').value = '';
    document.getElementById('input-prod').focus();
  }
  if(stepNum === 3) {
    document.getElementById('input-qty').focus();
    // ëª¨ë°”ì¼ í‚¤íŒ¨ë“œ ì˜¬ë¼ì˜¬ ë•Œ ìŠ¤í¬ë¡¤ ì¡°ì • ë“±ì„ ìœ„í•´ ì•½ê°„ ì§€ì—°
    setTimeout(() => document.getElementById('input-qty').select(), 100);
  }
  if(stepNum === 4) {
    document.getElementById('input-loc').value = '';
    document.getElementById('input-loc').focus();
  }
}

// --- ë¡œì§ ì²˜ë¦¬ ---

// [Step 1 -> 2] ì´ë¦„ ì…ë ¥ ì™„ë£Œ
function goStep2() {
  const name = document.getElementById('input-name').value.trim();
  if(!name) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
  workerName = name;
  showStep(2);
}

// [Step 2 -> 3] ìƒí’ˆ ìŠ¤ìº”
document.getElementById('input-prod').addEventListener('keypress', function(e) {
  if(e.key === 'Enter') {
    const code = this.value.trim();
    if(!code) return;
    
    // ë°ì´í„° ì¡°íšŒ
    const itemData = skuMap[code];
    if(itemData) {
      // itemData: [ìƒí’ˆëª…, ì½”ë“œ, ì§€ë²ˆ] (ê°€ì •)
      currentItem = {
        code: itemData[1],
        name: itemData[0],
        jibun: itemData[2],
        qty: 1
      };
      
      // í™”ë©´ ê°±ì‹ 
      document.getElementById('disp-pname').innerText = currentItem.name;
      document.getElementById('disp-pcode').innerText = currentItem.code;
      document.getElementById('input-qty').value = "1";
      
      showStep(3);
    } else {
      showMsg("âŒ", "ë¯¸ë“±ë¡ ìƒí’ˆ", "red");
      this.value = "";
    }
  }
});

// [Step 3 -> 4] ìˆ˜ëŸ‰ ì…ë ¥ ì™„ë£Œ
function goStep4() {
  const qty = document.getElementById('input-qty').value;
  if(!qty || qty < 1) { alert("ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”"); return; }
  
  currentItem.qty = qty;
  
  // ì§€ë²ˆ í‘œì‹œ
  document.getElementById('disp-jibun').innerText = currentItem.jibun;
  showStep(4);
}

// [Step 4 -> ì™„ë£Œ] ì§€ë²ˆ ìŠ¤ìº” ë° ì €ì¥
document.getElementById('input-loc').addEventListener('keypress', function(e) {
  if(e.key === 'Enter') {
    const scanLoc = this.value.trim();
    
    // ì§€ë²ˆ ì¼ì¹˜ ì—¬ë¶€ í™•ì¸ (ê³µë°± ì œê±° í›„ ë¹„êµ)
    if(scanLoc.replace(/\s/g,"") === currentItem.jibun.replace(/\s/g,"")) {
      saveData(scanLoc);
    } else {
      showMsg("âš ï¸", "ì§€ë²ˆ ë¶ˆì¼ì¹˜", "#ff6b00");
      this.value = "";
    }
  }
});

function saveData(loc) {
  document.getElementById('loading').style.display = 'flex';
  
  const payload = {
      workerName: workerName,
      prodCode: currentItem.code,
      prodName: currentItem.name,
      targetJibun: currentItem.jibun,
      scannedJibun: loc,
      qty: currentItem.qty
  };

  fetch(GAS_URL, {
    method: "POST", mode: "no-cors",
    body: JSON.stringify(payload)
  }).then(() => {
    document.getElementById('loading').style.display = 'none';
    showMsg("âœ…", "ì ì¹˜ ì™„ë£Œ", "green");
    
    // ì™„ë£Œ í›„ ë‹¤ì‹œ ìŠ¤ìº”í™”ë©´(Step 2)ìœ¼ë¡œ
    setTimeout(() => {
      showStep(2);
    }, 1000);
  });
}

// --- ìœ í‹¸ë¦¬í‹° ---
function showMsg(icon, text, color) {
  const overlay = document.getElementById('msg-overlay');
  document.getElementById('msg-icon').innerText = icon;
  const txtEl = document.getElementById('msg-text');
  txtEl.innerText = text;
  txtEl.style.color = color;
  
  overlay.style.display = "flex";
  setTimeout(() => overlay.style.display = "none", 1000);
}

function fullReset() {
  if(confirm("ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ? (ì´ë¦„ì€ ìœ ì§€ë©ë‹ˆë‹¤)")) {
    // ì´ë¦„ë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ ì´ˆê¸°í™”
    document.getElementById('input-prod').value = '';
    document.getElementById('input-qty').value = '1';
    document.getElementById('input-loc').value = '';
    currentItem = null;
    
    // ì´ë¦„ì´ ìˆìœ¼ë©´ 2ë²ˆ, ì—†ìœ¼ë©´ 1ë²ˆ
    if(workerName) showStep(2);
    else showStep(1);
  }
}
</script>
</body>
</html>