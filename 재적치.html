<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Kurly PDA (Final v3)</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">

<style>
  :root { --kurly-purple: #5f0080; --kurly-orange: #ff6b00; --bg-gray: #f4f4f4; }
  * { box-sizing: border-box; }
  body { height: 100vh; margin: 0; padding: 10px; overflow: hidden; font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-gray); display: flex; flex-direction: column; align-items: center; }
  
  .header { width: 100%; max-width: 400px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; flex-shrink: 0; }
  .logo { color: var(--kurly-purple); font-weight: 800; font-size: 18px; }
  
  /* ë””ë²„ê·¸ ë°”: ìŠ¤ìº” ê°’ì´ ì˜ ë“¤ì–´ì˜¤ëŠ”ì§€ ëˆˆìœ¼ë¡œ í™•ì¸ìš© */
  #debug-bar {
      width: 100%; max-width: 400px; background: #222; color: #0f0; 
      font-family: monospace; padding: 5px; font-size: 12px; margin-bottom: 5px;
      border-radius: 4px; min-height: 24px; text-align: center;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  #step-bar { width: 100%; max-width: 400px; display: flex; margin-bottom: 15px; flex-shrink: 0; background: #ddd; border-radius: 8px; overflow: hidden; }
  .step { flex: 1; text-align: center; padding: 10px 0; font-size: 14px; font-weight: bold; color: #999; }
  .step.active { background: var(--kurly-purple); color: white; }
  .step.active-2 { background: var(--kurly-orange); color: white; }
  
  /* ìŠ¤ìº” í‘œì‹œ ë°•ìŠ¤ (ì…ë ¥ì°½ ì•„ë‹˜ - í„°ì¹˜í•´ë„ í‚¤ë³´ë“œ ì•ˆ ëœ¸) */
  #scan-display-box { 
    width: 100%; max-width: 400px; padding: 15px; font-size: 20px; 
    border: 2px solid var(--kurly-purple); border-radius: 8px; 
    text-align: center; font-weight: bold; background: white; color: #333; margin-bottom: 15px;
    height: 60px; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  #guide-msg { width: 100%; max-width: 400px; text-align: center; font-size: 18px; font-weight: 800; margin-bottom: 10px; color: var(--kurly-purple); flex-shrink: 0; }

  #info-card { flex-grow: 1; width: 100%; max-width: 400px; background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: start; overflow-y: auto; }
  .val { font-size: 20px; font-weight: 700; color: #333; word-break: break-all; min-height: 30px;}
  
  /* íŒì—… ë° ì•Œë¦¼ */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; }
  #msg-overlay { z-index: 2001; color: white; pointer-events: none; flex-direction: column; }
  #msg-icon { font-size: 60px; margin-bottom: 20px; }
  #msg-text { font-size: 24px; font-weight: bold; }
  
  /* ìˆ˜ëŸ‰ ì…ë ¥ UI ìŠ¤íƒ€ì¼ */
  .inline-wrapper { display: flex; align-items: center; gap: 10px; margin-top: 5px; animation: fadeIn 0.3s; }
  .inline-qty-input { 
      width: 80px; padding: 8px; font-size: 22px; text-align: center; 
      border: 2px solid var(--kurly-purple); border-radius: 6px; 
      font-weight: bold; color: var(--kurly-purple);
      background: #fdfdfd; outline: none;
  }
  .inline-confirm-btn {
      padding: 8px 16px; background: var(--kurly-purple); color: white;
      border: none; border-radius: 6px; font-weight: bold; font-size: 14px;
      cursor: pointer;
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<div id="debug-bar">ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ (1234ë¡œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”)</div>

<div id="msg-overlay" class="modal-overlay" style="background: rgba(0,0,0,0.8);">
  <div id="msg-icon">âœ…</div>
  <div id="msg-text">ì™„ë£Œ</div>
</div>

<div class="header">
  <div class="logo">ì¬ì ì¹˜ PDA</div>
  <div style="font-size:12px; color:#666;">v3.0 ì „ì—­ê°ì§€</div>
</div>

<div id="step-bar">
  <div id="step1" class="step active">1. ìƒí’ˆ ìŠ¤ìº”</div>
  <div id="step2" class="step">2. ì§€ë²ˆ ìŠ¤ìº”</div>
</div>

<div id="guide-msg">í™”ë©´ì„ ì¼œê³ <br>ë°”ë¡œ ìŠ¤ìº”í•˜ì„¸ìš”</div>

<div id="scan-display-box">
  <span id="scan-text" style="color:#ccc;">ìŠ¤ìº” ëŒ€ê¸°ì¤‘...</span>
</div>

<div id="info-card">
  <div class="row">
    <div style="font-size:13px; color:#888;">ìƒí’ˆëª… (ìˆ˜ëŸ‰)</div>
    <div class="val" id="p-name">-</div>
  </div>
  
  <div id="target-area" style="background:#fff4e6; padding:15px; border-radius:8px; border:2px solid #ff6b00; text-align:center; display:none; margin-top:10px;">
    <div style="font-size:13px; color:#d9480f">â¬‡ï¸ ì´ ì§€ë²ˆì— ì ì¹˜</div>
    <div style="font-size:36px; font-weight:900; color:#ff6b00;" id="p-jibun">-</div>
  </div>
</div>

<script>
// [í…ŒìŠ¤íŠ¸ ë°ì´í„°] ë¡œë”© ì‹¤íŒ¨ ì‹œ ì‘ë™
const DUMMY_DATA = {
    "1234": ["ì‹ ë¼ë©´ ë´‰ì§€", "P001", "A-01-01", "ëƒ‰ì¥"],
    "8801": ["ì½”ì¹´ì½œë¼ 500ml", "P002", "B-02-03", "ìƒì˜¨"]
};

// êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ URL (ë³¸ì¸ ê²ƒìœ¼ë¡œ êµì²´ í•„ìš”)
const GAS_URL = "https://script.google.com/macros/s/AKfycbxlnPMPZAWhPum7f-yl3EVVn_wFqrh_v0GB6Edncx20eglrylv0iDbdET7o_jaPfj3e/exec";

let skuMap = {}; 
let currentStep = 1; 
let currentProduct = null;
let currentWorker = "ì‘ì—…ì"; 

// ìŠ¤ìº” ë²„í¼ ë³€ìˆ˜ (ë§¤ìš° ì¤‘ìš”)
let scanBuffer = "";
let scanTimer = null;

const els = {
    debugBar: document.getElementById("debug-bar"),
    scanText: document.getElementById("scan-text"),
    scanBox: document.getElementById("scan-display-box"),
    step1: document.getElementById("step1"),
    step2: document.getElementById("step2"),
    guide: document.getElementById("guide-msg"),
    pName: document.getElementById("p-name"),
    pJibun: document.getElementById("p-jibun"),
    targetArea: document.getElementById("target-area"),
    msgOverlay: document.getElementById("msg-overlay"),
    msgIcon: document.getElementById("msg-icon"),
    msgText: document.getElementById("msg-text")
};

// ì´ˆê¸°í™”
window.onload = function() {
    loadData();
};

async function loadData() {
  try {
    els.debugBar.innerText = "ë°ì´í„° ë¡œë”©ì¤‘...";
    const res = await fetch(GAS_URL + "?t=" + Date.now());
    const data = await res.json();
    skuMap = data;
    els.debugBar.innerText = "ë°ì´í„° ë¡œë“œ ì™„ë£Œ (" + Object.keys(data).length + "ê°œ)";
  } catch(e) {
    console.error(e);
    skuMap = DUMMY_DATA;
    els.debugBar.innerText = "âš ï¸ ì„œë²„ì—°ê²° ì‹¤íŒ¨. í…ŒìŠ¤íŠ¸ëª¨ë“œ(1234)";
  }
}

// ==========================================
// ğŸ”¥ í•µì‹¬ ë¡œì§: ì „ì—­ í‚¤ë³´ë“œ ê°ì§€
// ==========================================
document.addEventListener("keydown", (e) => {
    // 1. ìˆ˜ëŸ‰ ì…ë ¥ ì¤‘(input í¬ì»¤ìŠ¤)ì¼ ë•ŒëŠ” ìŠ¤ìº” ë¡œì§ ë¬´ì‹œ (ì‚¬ìš©ìê°€ ìˆ«ì ì¹˜ëŠ” ì¤‘)
    if (e.target.tagName === "INPUT") return;

    const char = e.key;

    // 2. Enter í‚¤ ê°ì§€ (ìŠ¤ìºë„ˆê°€ ì—”í„°ë¥¼ ë³´ë‚´ì£¼ëŠ” ê²½ìš°)
    if (char === "Enter") {
        if (scanBuffer.length > 0) {
            processScan(scanBuffer);
            scanBuffer = "";
        }
        return;
    }

    // 3. ì¼ë°˜ ë¬¸ì ê°ì§€ (íŠ¹ìˆ˜í‚¤ ì œì™¸)
    if (char.length === 1) {
        scanBuffer += char;
        
        // í™”ë©´ì— íƒ€ì´í•‘ ë˜ëŠ” ê²ƒ ë³´ì—¬ì£¼ê¸°
        els.scanText.innerText = scanBuffer;
        els.scanText.style.color = "#333";
        els.debugBar.innerText = "ì…ë ¥ì¤‘: " + scanBuffer;

        // 4. íƒ€ì´ë¨¸ ë¦¬ì…‹ (0.2ì´ˆ ë™ì•ˆ ì…ë ¥ ì—†ìœ¼ë©´ ìŠ¤ìº” ëë‚œ ê²ƒìœ¼ë¡œ ê°„ì£¼)
        clearTimeout(scanTimer);
        scanTimer = setTimeout(() => {
            if (scanBuffer.length > 0) {
                processScan(scanBuffer);
                scanBuffer = "";
            }
        }, 200); // 200ms ë”œë ˆì´
    }
});

function processScan(code) {
    code = code.trim();
    els.debugBar.innerText = "SCANNED: " + code;
    els.scanText.innerText = code;

    // "ë°˜ì§" íš¨ê³¼
    els.scanBox.style.backgroundColor = "#e6f7ff";
    els.scanBox.style.borderColor = "#007AFF";
    setTimeout(() => {
        els.scanBox.style.backgroundColor = "white";
        els.scanBox.style.borderColor = currentStep === 1 ? "#5f0080" : "#ff6b00";
    }, 300);

    if (currentStep === 1) {
        handleProductScan(code);
    } else {
        handleLocationScan(code);
    }
}

function handleProductScan(code) {
    const item = skuMap[code];
    if (item) {
        // ë°ì´í„° í¬ë§·: [ìƒí’ˆëª…, ì½”ë“œ, ì§€ë²ˆ, ì¡´]
        currentProduct = { code: item[1], name: item[0], jibun: item[2], qty: 1 };
        
        // ì„±ê³µ ì‹œ ìˆ˜ëŸ‰ ì…ë ¥ ëª¨ë“œë¡œ ì „í™˜
        showInlineQtyInput(item[0]); 
    } else {
        showMessage("âŒ", "ë¯¸ë“±ë¡ ìƒí’ˆ", "red");
        setTimeout(() => { 
            els.scanText.innerText = "ìŠ¤ìº” ëŒ€ê¸°ì¤‘..."; 
            els.scanText.style.color = "#ccc"; 
        }, 1000);
    }
}

function showInlineQtyInput(prodName) {
    // ì •ë³´ì°½ì„ ìˆ˜ëŸ‰ ì…ë ¥ UIë¡œ ë³€ê²½
    els.pName.innerHTML = `
        <div style="font-size:18px; margin-bottom:8px;">${prodName}</div>
        <div class="inline-wrapper">
            <span style="font-size:14px; color:#666;">ìˆ˜ëŸ‰:</span>
            <input type="tel" id="inline-qty" class="inline-qty-input" value="1" inputmode="numeric" pattern="[0-9]*">
            <button class="inline-confirm-btn" onclick="confirmQty()">í™•ì¸</button>
        </div>
    `;
    els.guide.innerText = "ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”";
    els.guide.style.color = "#333";

    // ìˆ˜ëŸ‰ ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤ (ì—¬ê¸°ì„œ í‚¤ë³´ë“œê°€ ëœ¸)
    const inlineInput = document.getElementById("inline-qty");
    
    // ìˆ˜ëŸ‰ ì…ë ¥ì°½ ì „ìš© ì—”í„°í‚¤ ì²˜ë¦¬
    inlineInput.addEventListener("keydown", (e) => {
        if(e.key === "Enter") confirmQty();
    });

    setTimeout(() => {
        inlineInput.focus();
        inlineInput.select(); // ìˆ«ì ì „ì²´ ì„ íƒ
    }, 100);
}

function confirmQty() {
    const inlineInput = document.getElementById("inline-qty");
    let val = "1";
    if (inlineInput) val = inlineInput.value.trim();
    if (!val || isNaN(val)) val = "1";
    
    currentProduct.qty = val;

    // í™”ë©´ ë³µêµ¬ (í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ)
    els.pName.innerHTML = `
        <div>${currentProduct.name}</div>
        <div style="font-size:16px; color:#5f0080; margin-top:5px;">(${currentProduct.qty}ê°œ)</div>
    `;
    
    els.pJibun.innerText = currentProduct.jibun;
    setStep(2);
    
    // ë‹¤ìŒ ìŠ¤ìº”ì„ ìœ„í•œ UI ì´ˆê¸°í™”
    els.scanText.innerText = "ì§€ë²ˆ ìŠ¤ìº”...";
    els.scanText.style.color = "#ccc";
}

function handleLocationScan(scannedJibun) {
    const targetJibun = currentProduct.jibun;
    
    // ê³µë°± ì œê±° ë¹„êµ
    if (scannedJibun.replace(/\s/g, "") === targetJibun.replace(/\s/g, "")) {
        showMessage("âœ…", "ì™„ë£Œ!", "green");
        
        // (ì„ íƒ) ì—¬ê¸°ì„œ ì„œë²„ ì „ì†¡ ë¡œì§ ìˆ˜í–‰ (saveLog)
        
        setTimeout(() => resetToStep1(), 1000);
    } else {
        showMessage("âš ï¸", "ì§€ë²ˆ ë¶ˆì¼ì¹˜", "#ff6b00");
    }
}

function setStep(step) {
    currentStep = step;
    if (step === 1) {
        els.step1.classList.add("active");
        els.step2.classList.remove("active-2");
        els.guide.innerText = "ìƒí’ˆ ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”";
        els.guide.style.color = "#5f0080";
        els.targetArea.style.display = "none";
        els.scanBox.style.borderColor = "#5f0080";
    } else {
        els.step1.classList.remove("active");
        els.step2.classList.add("active-2");
        els.guide.innerText = "ì§€ë²ˆ ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”";
        els.guide.style.color = "#ff6b00";
        els.targetArea.style.display = "block";
        els.scanBox.style.borderColor = "#ff6b00";
    }
}

function resetToStep1() {
    setStep(1);
    els.pName.innerText = "-";
    els.pJibun.innerText = "-";
    els.scanText.innerText = "ìŠ¤ìº” ëŒ€ê¸°ì¤‘...";
    els.scanText.style.color = "#ccc";
    currentProduct = null;
}

function showMessage(icon, text, color) {
    els.msgIcon.innerText = icon;
    els.msgText.innerHTML = text;
    els.msgText.style.color = color;
    els.msgOverlay.style.display = 'flex';
    setTimeout(() => els.msgOverlay.style.display = 'none', 1000);
}
</script>
</body>
</html>